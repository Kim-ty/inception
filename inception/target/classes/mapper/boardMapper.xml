<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.inception.mapper.boardMapper">

	<insert id="boardInsert" >
			insert all
			into board(BIDX,TITLE,USERID,WRITEDATE,CONTENTS,CATEGORY) VALUES(createbidx.nextval,#{title},#{userid},sysdate,#{contents},#{category})
			<foreach collection="tagList" item="tagitem" index="index">
			into boardtag(bidx,tag) values(createbidx.nextval,#{tagitem.tag})
			</foreach>
			SELECT * FROM dual
			
	</insert>

	<update id="boardUpdate" >
		<![CDATA[
			update board
			set CONTENTS = #{contents}
			where bidx = #{bidx}
		]]>

	</update>

	<insert id="replyInsert">

		<![CDATA[
			insert into BOARDREPLY(ridx,bidx,userid,writedate,contents,TARGETREPLY) values(createridx.nextval,#{bidx},#{userid},sysdate,#{contents},#{targetreply})
		]]>
	</insert>

	<insert id="Scrape">
		<![CDATA[
			insert into scrape(bidx,userid,scrapedate) values(#{bidx},#{userid},sysdate)
		]]>

	</insert>
	
	<select id="scrapcheck" resultType="int">
		<![CDATA[
			select count(*) from scrape where bidx=#{bidx} and userid=#{userid}
		]]>
	</select>

	<insert id="good">
		<![CDATA[
			insert into goodbad(bidx,g_b_count,userid) VALUES(#{bidx},0,#{userid})
		]]>

	</insert>
	
	<select id="goodcheck" resultType="int">
		<![CDATA[
			select count(*) from goodbad where bidx=#{bidx} and userid = #{userid}
		]]>
	</select>

	<insert id="bad">
		<![CDATA[
			insert into goodbad(bidx,g_b_count,userid) VALUES(#{bidx},1,#{userid})
		]]>

	</insert>

	<select id="boardList" resultType="kr.co.inception.board.vo.BoardListVO">
		<![CDATA[ 
			select b.bidx,b.hitcount as hitcnt,SUBSTR(REGEXP_REPLACE(b.contents, '<[^>]*>|\&([^;])*;', ''),1,25) as contents,b.title,b.userid,b.writedate,b.category,nvl(gb.gcnt,0) AS gcnt,nvl(gb.bcnt,0) as bcnt,nvl(s.scrapecnt,0) AS scrapecnt,nvl(rp.rpcnt,0) as rpcnt
			from ( select distinct bidx,HITCOUNT,contents,TITLE,USERID,WRITEDATE,CATEGORY from board ) b
			left join ( select bidx, count(decode(g_b_count,'0','1')) as gcnt,count(decode(g_b_count,'1','1')) as bcnt from goodbad group by bidx ) gb ON b.bidx = gb.bidx
			left join ( select bidx, count(*) as scrapecnt from scrape group by bidx ) s ON b.bidx = s.bidx
			left join ( select bidx, count(*) as rpcnt from BoardReply group by bidx) rp on b.bidx = rp.bidx
			order by b.writedate desc
			
		]]>
	</select>
	
	<select id ="boardListCategory" resultType="kr.co.inception.board.vo.BoardListVO">
		<![CDATA[ 
			select b.bidx,b.hitcount as hitcnt,SUBSTR(REGEXP_REPLACE(b.contents, '<[^>]*>|\&([^;])*;', ''),1,25) as contents,b.title,b.userid,b.writedate,b.category,nvl(gb.gcnt,0) AS gcnt,nvl(gb.bcnt,0) as bcnt,nvl(s.scrapecnt,0) AS scrapecnt,nvl(rp.rpcnt,0) as rpcnt
			from ( select distinct bidx,HITCOUNT,contents,TITLE,USERID,WRITEDATE,CATEGORY from board ) b
			left join ( select bidx, count(decode(g_b_count,'0','1')) as gcnt,count(decode(g_b_count,'1','1')) as bcnt from goodbad group by bidx ) gb ON b.bidx = gb.bidx
			left join ( select bidx, count(*) as scrapecnt from scrape group by bidx ) s ON b.bidx = s.bidx
			left join ( select bidx, count(*) as rpcnt from BoardReply group by bidx) rp on b.bidx = rp.bidx
			where category =#{category}
			order by b.writedate desc
		]]>		
	</select>
	
	<select id = "boardListTag" resultType="kr.co.inception.board.vo.BoardListVO">
		<![CDATA[ 
			select b.bidx,b.hitcount as hitcnt,SUBSTR(REGEXP_REPLACE(b.contents, '<[^>]*>|\&([^;])*;', ''),1,25) as contents,b.title,b.userid,b.writedate,b.category,nvl(gb.gcnt,0) AS gcnt,nvl(gb.bcnt,0) as bcnt,nvl(s.scrapecnt,0) AS scrapecnt,nvl(rp.rpcnt,0) as rpcnt
			from ( select distinct bidx,HITCOUNT,contents,TITLE,USERID,WRITEDATE,CATEGORY from board ) b
			left join ( select bidx, count(decode(g_b_count,'0','1')) as gcnt,count(decode(g_b_count,'1','1')) as bcnt from goodbad group by bidx ) gb ON b.bidx = gb.bidx
			left join ( select bidx, count(*) as scrapecnt from scrape group by bidx ) s ON b.bidx = s.bidx
			left join ( select bidx, count(*) as rpcnt from BoardReply group by bidx) rp on b.bidx = rp.bidx
			left join ( select bidx, tag from boardtag) t on b.bidx = t.bidx
			where tag =#{tag}
			order by b.writedate desc
		]]>		
		
	</select>
	
	<select id="boardDetail" resultType="kr.co.inception.board.vo.BoardDetailVO">
		<![CDATA[
		
		
		]]>
	</select>

	<select id="boardSimple" resultType="kr.co.inception.board.vo.BoardSimpleVO">
		<![CDATA[
			select b.bidx,b.title,b.userid,b.writedate,b.contents,b.hitcount,b.category,t.tag,g.good,b.bad,s.scrapecount,r.replycount
			from board b,
    			(select listagg(tag,',')within group(order by bidx) as tag
    			from boardtag
    			where bidx=#{bidx}
    			) t,
    			(select count(g_b_count) as good
    			from goodbad
    			where bidx=#{bidx} and g_b_count = 0
    			) g,
    			(select count(g_b_count) as bad
    			from goodbad
    			where bidx=#{bidx} and g_b_count =1) b,
    			(select count(*) as scrapecount
    			from scrape
    			where bidx=#{bidx}
    			) s,
   				(select count(*) as replycount
   				from boardreply
   				where bidx=#{bidx}
   				) r
			where b.bidx = #{bidx}
		]]>

	</select>

	<select id="GooderList" resultType="kr.co.inception.board.vo.GooderListVO">
		<![CDATA[
			select bidx,userid from goodbad where bidx =#{bidx} and g_b_count =0
		]]>

	</select>

	<select id="baderList" resultType="kr.co.inception.board.vo.BaderListVO">
		<![CDATA[
		select bidx,userid from goodbad where bidx =#{bidx} and g_b_count =1
		]]>

	</select>

	<select id="replyList" resultType="kr.co.inception.board.vo.ReplyListVO">
		<![CDATA[
			select ridx,nvl(TARGETREPLY,0) as targetreply,contents,level,bidx,writedate,userid
			from BOARDREPLY
			where bidx = #{bidx}
			start with targetreply is null
			connect by prior ridx = TARGETREPLY
		]]>

	</select>
	<select id="replyList2" resultType="kr.co.inception.board.vo.ReplyListVO">
		<![CDATA[
			select ridx,TARGETREPLY,lpad('â”” ',3*(level-1)) || contents  as contents,userid,writedate,level,bidx
from BOARDREPLY
where bidx =#{bidx}
start with targetreply is null
connect by prior ridx = TARGETREPLY
		]]>

	</select>

	<select id="scrapeList" resultType="kr.co.inception.board.vo.ScraperListVO">
		<![CDATA[
			select bidx,userid from scrape where bidx = #{bidx}
		]]>

	</select>
	
	<select id="searchkeyword" resultType="kr.co.inception.board.vo.BoardListVO">
		<![CDATA[
		select b.bidx,b.hitcount as hitcnt,SUBSTR(b.contents, 1, 25) as contents,b.title,b.userid,b.writedate,b.category,nvl(gb.gcnt,0) AS gcnt,nvl(gb.bcnt,0) as bcnt,nvl(s.scrapecnt,0) AS scrapecnt,nvl(rp.rpcnt,0) as rpcnt
			from ( select distinct bidx,HITCOUNT,contents,TITLE,USERID,WRITEDATE,CATEGORY from board ) b
			left join ( select bidx, count(decode(g_b_count,'0','1')) as gcnt,count(decode(g_b_count,'1','1')) as bcnt from goodbad group by bidx ) gb ON b.bidx = gb.bidx
			left join ( select bidx, count(*) as scrapecnt from scrape group by bidx ) s ON b.bidx = s.bidx
			left join ( select bidx, count(*) as rpcnt from BoardReply group by bidx) rp on b.bidx = rp.bidx where title like #{searchkeyword} or userid like #{searchkeyword} or contents like #{searchkeyword}
		]]>
	</select>
	
	<update id="hit">
  		<![CDATA[update board set hitcount = hitcount+1 where bidx =#{bidx}]]>
	</update>
	
		
	<select id="tagList" resultType="kr.co.inception.board.vo.TagListVO">
		<![CDATA[
			select tag from boardtag where tag is not null group by tag order by count(tag) desc
		]]>
	</select>
  
	

</mapper>
  
